# История изменений ValgAce

## [1.1.0] - 2025-09-26
### Исправлено
- Исправлена проблема с командой `ACE_CHANGE_TOOL`, которая не работала корректно при смене инструмента

### Добавлено
- Новая функция `_perform_retract_for_toolchange` для выполнения ретракта старого инструмента с правильной синхронизацией
- Новая функция `_start_feed_for_toolchange` для подачи нового инструмента с корректной обработкой состояния
- Функция `_start_toolchange_timeout` для реализации таймаута (45 секунд) на всю операцию смены инструмента
- Функция `_handle_toolchange_error` для восстановления состояния при ошибках смены инструмента
- Атрибут `_toolchange_timeout_timer` для отслеживания таймера таймаута смены инструмента

### Улучшено
- Обновлена функция `_park_to_toolhead` для лучшей проверки состояния до начала операции
- Улучшена функция `_wait_for_slot_ready` с более частыми проверками (0.2 секунды) и вызовом `_request_status()` для получения актуального состояния
- Улучшена функция `_complete_parking` с отменой таймера таймаута смены инструмента и корректной логикой выполнения `_ACE_POST_TOOLCHANGE`
- Обновлена функция `cmd_ACE_CHANGE_TOOL` для использования новых функций и запуска таймера таймаута
- Разделена логика смены инструмента на отдельные фазы для предотвращения конфликтов между операциями ретракта и подачи

### Изменения в коде

#### 1. Добавлены новые функции:
```python
def _start_toolchange_timeout(self):
    """Запускает таймер таймаута для всей операции смены инструмента"""
    def timeout_handler(eventtime):
        if self._park_in_progress and self._park_is_toolchange:
            self.gcode.respond_raw(f"[ACE] Toolchange timeout - cancelling operation")
            self._complete_parking(success=False, error="Toolchange timeout")
        return self.reactor.NEVER
    
    wake_time = self.reactor.monotonic() + 45.0  # 45 секунд таймаут
    self._toolchange_timeout_timer = self.reactor.register_timer(timeout_handler, wake_time)

def _perform_retract_for_toolchange(self, local_was, local_tool, gcmd):
    """Выполняет ретракт старого инструмента и затем подачу нового"""
    # Устанавливаем флаги смены инструмента
    self._park_is_toolchange = True
    self._park_previous_tool = local_was
    
    # Логика ретракта и переход к подаче нового инструмента

def _start_feed_for_toolchange(self, local_tool, gcmd):
    """Начинает подачу нового инструмента"""
    # Устанавливаем флаги смены инструмента если еще не установлены
    # Логика подачи нового инструмента
```

#### 2. Улучшена функция _wait_for_slot_ready:
- Изменен интервал проверки с 0.5 до 0.2 секунды
- Добавлен вызов `_request_status()` для получения актуального состояния
- Добавлено информирование о текущем состоянии слота при таймауте

#### 3. Улучшена функция _complete_parking:
- Добавлена отмена таймера таймаута смены инструмента
- Улучшена логика выполнения `_ACE_POST_TOOLCHANGE` после успешной смены инструмента

#### 4. Обновлена функция cmd_ACE_CHANGE_TOOL:
- Добавлен запуск таймера таймаута смены инструмента
- Использование новых функций для разделения логики ретракта и подачи
- Добавлены сообщения для отладки процесса смены инструмента

#### 5. Добавлены атрибуты класса:
- `_toolchange_timeout_timer` в конструкторе класса для отслеживания таймера таймаута смены инструмента